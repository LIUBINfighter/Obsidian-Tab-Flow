# Tab Flow 插件架构总览

## 相关代码文件
- `src/main.ts` - 插件主入口文件
- `src/types/assets.ts` - 资源类型定义
- `src/settings/defaults.ts` - 默认设置配置

## 架构设计

### 核心模块
Tab Flow 插件采用模块化设计，主要分为以下几个核心模块：

1. **主插件模块 (TabFlowPlugin)**
   - 插件生命周期管理
   - 资源加载和资产管理
   - 设置管理
   - 视图注册

2. **服务层 (Services)**
   - AlphaTab 服务集成
   - 资源加载服务
   - 外部媒体服务
   - 滚动配置代理

3. **视图层 (Views)**
   - 标签视图 (TabView)
   - 文档视图 (DocView)
   - Markdown 集成

4. **组件系统 (Components)**
   - 播放控制组件
   - 导出模态框
   - 音频播放器
   - 进度条组件

5. **事件系统 (Events)**
   - API 事件处理
   - 播放器事件
   - 滚动事件
   - 轨道事件

### 数据流架构

```
用户操作 → 事件系统 → 服务层 → AlphaTab引擎 → 视图更新
```

### 资源管理流程

```typescript
// 资源检查流程
async checkRequiredAssets(): Promise<boolean | AssetStatus[]> {
  // 1. 检查插件目录
  // 2. 检查assets目录存在性
  // 3. 检查具体资源文件(Bravura字体、SoundFont、AlphaTab worker)
  // 4. 返回详细状态或简单布尔结果
}
```

### 插件初始化流程

1. **加载设置**: 从Obsidian存储加载用户配置
2. **确定插件目录**: 存储实际的插件路径
3. **注册设置面板**: 添加设置选项卡
4. **注册视图**: 注册TabView和DocView
5. **加载资源**: 使用ResourceLoaderService加载所需资源
6. **注册Markdown处理器**: 设置alphatex代码块处理器
7. **注册文件扩展名**: 关联文件类型与视图
8. **添加上下文菜单**: 添加文件操作菜单项

### 关键设计决策

1. **资源延迟加载**: 资源在需要时才加载，避免启动性能问题
2. **事件驱动架构**: 使用自定义事件总线进行组件间通信
3. **主题适配**: 完全集成Obsidian的CSS变量系统
4. **模块化设计**: 每个功能模块独立，便于维护和扩展
5. **错误处理**: 完善的错误处理和用户反馈机制

### 性能考虑

- 使用Data URL内联资源减少HTTP请求
- 实现资源缓存机制
- 支持大文件的分块加载
- 提供性能配置选项

这个架构设计确保了插件的可扩展性、可维护性和良好的用户体验。
